// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String?  // Optional for OAuth users
  firstName    String?
  lastName     String?
  phone        String?
  dateOfBirth  DateTime?
  verified     Boolean   @default(false)
  role         UserRole  @default(USER)
  kycStatus    KYCStatus @default(PENDING)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // OAuth fields
  googleId      String?  @unique
  provider      String?  // 'google', 'email', etc.
  avatar        String?  // Profile picture URL from OAuth
  oauthData     Json?    // Additional OAuth data

  // New fields
  timezone              String?          @default("UTC")
  preferredCurrency     String           @default("USD")
  subscriptionTier      SubscriptionTier @default(FREE)
  subscriptionExpiresAt DateTime?
  alertPreferences      Json? // { valueBetMin: 5, sports: [...], platforms: [...] }
  preferredMode         String?          @default("pro") // "casual" | "pro" - Modo de uso preferido

  // Cached statistics
  totalBets       Int       @default(0)
  totalWins       Int       @default(0)
  totalLosses     Int       @default(0)
  totalStaked     Float     @default(0)
  totalWon        Float     @default(0)
  roi             Float     @default(0)
  winRate         Float     @default(0)
  lastStatsUpdate DateTime?

  // Referral system
  referralCode   String?  @unique // Unique referral code for this user
  referredBy     String?  // User ID who referred this user
  referralCount  Int      @default(0) // How many users this user has referred
  activeReferrals Int     @default(0) // Active (subscribed) referrals
  referralRewards Json?   // { freeMonths: 0, discount: 0, premiumAccess: false }

  // Relations
  bets           Bet[]
  sessions       Session[]
  rgSettings     ResponsibleGaming?
  transactions   Transaction[]
  addresses      Address[]
  externalBets   ExternalBet[]
  valueBetAlerts ValueBetAlert[]
  notifications  Notification[]
  userStatistics UserStatistics[]
  subscription   Subscription?
  payments       Payment[]
  referrals      User[]  @relation("UserReferrals") // Users referred by this user
  referrer       User?   @relation("UserReferrals", fields: [referredBy], references: [id])
  referralRecords Referral[] @relation("Referrer") // Referrals made by this user
  referredRecord  Referral?   @relation("Referred") // Referral record for this user
  betTemplates   BetTemplate[] // Bet templates created by user

  @@index([email])
  @@index([role])
  @@index([subscriptionTier])
  @@index([referralCode])
  @@index([referredBy])
}

enum UserRole {
  USER
  TRADER
  ADMIN
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  PRO
}

enum KYCStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
}

model Sport {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  icon      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events  Event[]
  markets Market[]

  @@index([slug])
}

model Event {
  id         String      @id @default(cuid())
  externalId String?     @unique
  sportId    String
  name       String
  startTime  DateTime
  status     EventStatus @default(SCHEDULED)
  homeTeam   String
  awayTeam   String
  homeScore  Int?        @default(0)
  awayScore  Int?        @default(0)
  isActive   Boolean     @default(true) // ⚠️ CRÍTICO: Para filtrar eventos activos
  metadata   Json?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  sport          Sport                @relation(fields: [sportId], references: [id])
  markets        Market[]
  odds           Odds[]
  bets           Bet[]
  oddsHistory    OddsHistory[]
  playerTracking PlayerTrackingData[]
  matchMetrics   MatchMetrics?
  ExternalBet    ExternalBet[]
  ValueBetAlert  ValueBetAlert[]
  OddsComparison OddsComparison[]
  Prediction     Prediction[]

  @@index([sportId])
  @@index([status])
  @@index([startTime])
  @@index([externalId])
  @@index([isActive])
  @@index([status, startTime]) // Composite index for upcoming/live events queries
  @@index([sportId, status, startTime]) // Composite index for filtered event queries
}

enum EventStatus {
  SCHEDULED
  LIVE
  FINISHED
  CANCELLED
  SUSPENDED
}

model Market {
  id          String     @id @default(cuid())
  eventId     String
  sportId     String
  type        MarketType
  name        String
  isActive    Boolean    @default(true)
  isSuspended Boolean    @default(false)
  metadata    Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  event           Event            @relation(fields: [eventId], references: [id])
  sport           Sport            @relation(fields: [sportId], references: [id])
  odds            Odds[]
  bets            Bet[]
  valueBetAlerts  ValueBetAlert[]
  oddsComparisons OddsComparison[]
  predictions     Prediction[]

  @@index([eventId])
  @@index([type])
  @@index([isActive])
}

enum MarketType {
  MATCH_WINNER
  OVER_UNDER
  HANDICAP
  BOTH_TEAMS_SCORE
  CORRECT_SCORE
  PLAYER_PROP
  CUSTOM
}

model Odds {
  id          String   @id @default(cuid())
  eventId     String
  marketId    String
  selection   String // e.g., "home", "away", "draw", "over 2.5"
  decimal     Float
  american    Int?
  fractional  String?
  probability Float // Calculated probability
  source      String   @default("SYSTEM") // SYSTEM, ML_MODEL, MANUAL, SPORTRADAR
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event  Event  @relation(fields: [eventId], references: [id])
  market Market @relation(fields: [marketId], references: [id])
  bets   Bet[]

  @@index([eventId])
  @@index([marketId])
  @@index([isActive])
}

model OddsHistory {
  id        String   @id @default(cuid())
  eventId   String
  marketId  String
  selection String
  decimal   Float
  timestamp DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([timestamp])
}

// Player-level granular data (from ShotTracker, KINEXON, etc.)
model PlayerTrackingData {
  id           String   @id @default(cuid())
  eventId      String
  playerId     String
  playerName   String
  positionX    Float
  positionY    Float
  positionZ    Float?
  velocity     Float
  acceleration Float
  timestamp    DateTime @default(now())
  metadata     Json? // Additional tracking data

  event Event @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([playerId])
  @@index([timestamp])
}

// Aggregated match metrics from player tracking
model MatchMetrics {
  id            String   @id @default(cuid())
  eventId       String   @unique
  playerMetrics Json // Map of playerId -> PlayerMetrics
  teamMetrics   Json // Team-level aggregated data
  ballMetrics   Json // Ball tracking metrics
  timestamp     DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([timestamp])
}

model Bet {
  id           String     @id @default(cuid())
  userId       String
  eventId      String
  marketId     String
  oddsId       String
  type         BetType
  selection    String
  stake        Float
  potentialWin Float
  oddsDecimal  Float
  status       BetStatus  @default(PENDING)
  result       BetResult?
  settledAt    DateTime?
  metadata     Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id])
  market Market @relation(fields: [marketId], references: [id])
  odds   Odds   @relation(fields: [oddsId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
}

enum BetType {
  SINGLE
  MULTIPLE
  SYSTEM
}

enum BetStatus {
  PENDING
  ACCEPTED
  WON
  LOST
  VOID
  CANCELLED
}

enum BetResult {
  WON
  LOST
  VOID
  HALF_WON
  HALF_LOST
}

model ResponsibleGaming {
  id                 String    @id @default(cuid())
  userId             String    @unique
  depositLimit       Float?
  depositPeriod      String? // daily, weekly, monthly
  lossLimit          Float?
  lossPeriod         String?
  sessionLimit       Int? // minutes
  selfExcluded       Boolean   @default(false)
  selfExclusionUntil DateTime?
  alerts             Json? // Array of alerts
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model RiskExposure {
  id                 String   @id @default(cuid())
  eventId            String
  marketId           String
  selection          String
  totalStake         Float    @default(0)
  potentialLiability Float    @default(0)
  betCount           Int      @default(0)
  updatedAt          DateTime @updatedAt

  @@unique([eventId, marketId, selection])
  @@index([eventId])
}

model FraudAlert {
  id          String        @id @default(cuid())
  type        FraudType
  severity    AlertSeverity
  description String
  userId      String?
  eventId     String?
  betId       String?
  source      String        @default("SYSTEM") // SYSTEM, SPORTRADAR_UFDS, ML_MODEL
  metadata    Json?
  resolved    Boolean       @default(false)
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())

  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@index([source])
}

enum FraudType {
  MATCH_FIXING
  ARBITRAGE
  COLLUSION
  ACCOUNT_FRAUD
  PAYMENT_FRAUD
  OTHER
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Transaction {
  id        String            @id @default(cuid())
  userId    String
  type      TransactionType
  amount    Float
  currency  String            @default("USD")
  status    TransactionStatus @default(PENDING)
  method    String?
  reference String?           @unique
  metadata  Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BET_PLACED
  BET_WON
  BET_REFUND
  BONUS
  FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Address {
  id        String      @id @default(cuid())
  userId    String
  type      AddressType
  street    String
  city      String
  state     String?
  zipCode   String
  country   String
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum AddressType {
  BILLING
  SHIPPING
  KYC
}

// ============================================
// PAYMENT AND SUBSCRIPTION MODELS
// ============================================

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  cancelledAt          DateTime?
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
  TRIALING
}

model Payment {
  id              String        @id @default(cuid())
  userId          String
  subscriptionId  String?
  stripePaymentId String?       @unique
  stripeInvoiceId String?       @unique
  amount          Float
  currency        String        @default("EUR")
  status          PaymentStatus @default(PENDING)
  paymentMethod   String?
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([stripePaymentId])
  @@index([status])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// NEW MODELS FOR PERFECT DATA MODEL
// ============================================

// Model for tracking bets placed on external platforms
model ExternalBet {
  id              String  @id @default(cuid())
  userId          String
  eventId         String?
  externalEventId String? // ID del evento en la plataforma externa

  // Información de la plataforma externa
  platform      String // "Bet365", "Betfair", "Pinnacle", etc.
  platformBetId String? // ID de la apuesta en la plataforma externa
  platformUrl   String? // Link al ticket de apuesta

  // Detalles de la apuesta
  marketType String // "Match Winner", "Over/Under", etc.
  selection  String // "Home", "Away", "Over 2.5", etc.
  odds       Float
  stake      Float
  currency   String @default("USD")

  // Estado y resultado
  status    ExternalBetStatus @default(PENDING)
  result    BetResult?
  actualWin Float? // Ganancia real si ganó
  settledAt DateTime?

  // Metadata
  notes    String? // Notas del usuario
  tags     String[] // Tags personalizados
  metadata Json? // Datos adicionales

  // Timestamps
  betPlacedAt  DateTime // Cuándo se hizo la apuesta (en la plataforma externa)
  registeredAt DateTime @default(now()) // Cuándo se registró en BETAPREDIT
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  user          User           @relation(fields: [userId], references: [id])
  event         Event?         @relation(fields: [eventId], references: [id])
  valueBetAlert ValueBetAlert? // Si fue detectado como value bet antes de apostar (one-to-one)

  @@index([userId])
  @@index([eventId])
  @@index([platform])
  @@index([status])
  @@index([betPlacedAt])
  @@index([registeredAt])
}

// Template for frequently used bets
model BetTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String   // Template name (e.g., "My Football Strategy")
  description String?  // Optional description
  
  // Template data
  platform    String   // Default platform
  marketType  String   // Default market type
  defaultStake Float?  // Default stake amount
  tags        String[] // Tags for organization
  
  // Usage tracking
  useCount    Int      @default(0)
  lastUsedAt  DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([name])
}

enum ExternalBetStatus {
  PENDING // Apuesta registrada, evento no ha terminado
  WON
  LOST
  VOID
  CANCELLED
  PARTIAL_WIN // Para apuestas múltiples
}

// Model for value bet alerts
model ValueBetAlert {
  id        String  @id @default(cuid())
  userId    String? // null = alerta pública/general
  eventId   String
  marketId  String
  selection String

  // Cálculo de valor
  bookmakerOdds        Float // Mejor cuota disponible
  bookmakerPlatform    String // Plataforma con mejor cuota
  predictedProbability Float // Probabilidad calculada por IA
  expectedValue        Float // EV calculado
  valuePercentage      Float // % de valor (ej: +12.5%)
  confidence           Float // Confianza del modelo (0-1)

  // Estado
  status        ValueBetStatus @default(ACTIVE)
  notifiedAt    DateTime?
  clickedAt     DateTime? // Si el usuario hizo clic
  betPlaced     Boolean        @default(false) // Si el usuario registró una apuesta
  externalBetId String?        @unique // Si se registró la apuesta (one-to-one)

  // Metadata
  factors   Json? // Factores que influyeron (lesiones, forma, etc.)
  createdAt DateTime @default(now())
  expiresAt DateTime // Cuándo expira la oportunidad

  // Relaciones
  event       Event        @relation(fields: [eventId], references: [id])
  market      Market       @relation(fields: [marketId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])
  externalBet ExternalBet? @relation(fields: [externalBetId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([valuePercentage])
  @@index([expiresAt])
  @@index([createdAt])
}

enum ValueBetStatus {
  ACTIVE // Oportunidad activa
  EXPIRED // Oportunidad expiró
  TAKEN // Usuario tomó la oportunidad
  INVALID // Ya no es válida (cuota cambió)
}

// Model for comparing odds across multiple platforms
model OddsComparison {
  id        String @id @default(cuid())
  eventId   String
  marketId  String
  selection String

  // Cuotas de múltiples plataformas
  oddsByPlatform Json // { "Bet365": 2.10, "Betfair": 2.15, ... }

  // Análisis
  bestOdds      Float // Mejor cuota disponible
  bestPlatform  String // Plataforma con mejor cuota
  averageOdds   Float // Promedio de cuotas
  maxDifference Float // Diferencia máxima entre plataformas

  // Timestamps
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())

  // Relaciones
  event  Event  @relation(fields: [eventId], references: [id])
  market Market @relation(fields: [marketId], references: [id])

  @@unique([eventId, marketId, selection])
  @@index([eventId])
  @@index([lastUpdated])
}

// Model for odds providers
model OddsProvider {
  id              String    @id @default(cuid())
  name            String    @unique // "Bet365", "Betfair", etc.
  slug            String    @unique
  apiEndpoint     String? // URL de API si está disponible
  apiKey          String? // Encriptado
  isActive        Boolean   @default(true)
  updateFrequency Int       @default(60) // Segundos entre actualizaciones
  lastSync        DateTime?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([isActive])
}

// Model for predictions with accuracy tracking
model Prediction {
  id        String @id @default(cuid())
  eventId   String
  marketId  String
  selection String

  // Predicción
  predictedProbability Float // Probabilidad predicha
  confidence           Float // Confianza del modelo
  modelVersion         String // Versión del modelo usado
  factors              Json // Factores considerados

  // Resultado real (se actualiza cuando el evento termina)
  actualResult String? // "WON", "LOST", etc.
  wasCorrect   Boolean?
  accuracy     Float? // Diferencia entre predicho y real

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  eventFinishedAt DateTime?

  // Relaciones
  event  Event  @relation(fields: [eventId], references: [id])
  market Market @relation(fields: [marketId], references: [id])

  @@index([eventId])
  @@index([wasCorrect])
  @@index([createdAt])
  @@index([eventId, marketId]) // Composite index for common query pattern
  @@index([eventId, selection]) // Composite index for event + selection queries
}

// Model for tracking ML model performance
model ModelPerformance {
  id           String @id @default(cuid())
  modelVersion String
  modelType    String // "ML", "STATISTICAL", "HYBRID"

  // Métricas
  totalPredictions   Int   @default(0)
  correctPredictions Int   @default(0)
  accuracy           Float // Precisión general
  accuracyBySport    Json // { "Football": 0.65, "Basketball": 0.72, ... }
  accuracyByMarket   Json // { "MATCH_WINNER": 0.68, "OVER_UNDER": 0.71, ... }

  // Calibración
  calibrationScore Float? // Qué tan bien calibrado está el modelo
  brierScore       Float? // Brier score

  // Timestamps
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())

  @@unique([modelVersion])
  @@index([modelVersion])
  @@index([accuracy])
}

// Model for aggregated user statistics
model UserStatistics {
  id          String    @id @default(cuid())
  userId      String
  period      String // "daily", "weekly", "monthly", "all_time"
  periodStart DateTime
  periodEnd   DateTime?

  // Métricas
  totalBets   Int   @default(0)
  totalWins   Int   @default(0)
  totalLosses Int   @default(0)
  totalVoids  Int   @default(0)
  totalStaked Float @default(0)
  totalWon    Float @default(0)
  totalLost   Float @default(0)
  netProfit   Float @default(0)
  roi         Float @default(0)
  winRate     Float @default(0)

  // Por deporte
  statsBySport Json // { "Football": { bets: 10, wins: 7, roi: 15.2 }, ... }

  // Por plataforma
  statsByPlatform Json // { "Bet365": { bets: 5, wins: 4, roi: 12.1 }, ... }

  // Por tipo de mercado
  statsByMarket Json // { "MATCH_WINNER": { bets: 8, wins: 6, ... }, ... }

  // Value bets
  valueBetsFound Int   @default(0)
  valueBetsTaken Int   @default(0)
  valueBetsWon   Int   @default(0)
  valueBetsROI   Float @default(0)

  // Timestamps
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, period, periodStart])
  @@index([period])
}

// Referral system
model Referral {
  id              String   @id @default(cuid())
  referrerId      String   // User who referred
  referredUserId  String   @unique // User who was referred
  referralCode    String   // Code used for referral
  status          ReferralStatus @default(PENDING)
  rewardGranted   Boolean  @default(false)
  rewardType      String?  // 'free_month', 'discount', 'premium_access'
  rewardValue     Float?   // Value of reward (e.g., discount percentage)
  convertedAt     DateTime? // When referred user became active (subscribed)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  referrer        User     @relation("Referrer", fields: [referrerId], references: [id])
  referredUser    User     @relation("Referred", fields: [referredUserId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
}

enum ReferralStatus {
  PENDING      // User registered but not active
  ACTIVE       // User has active subscription
  REWARDED     // Reward already granted
  EXPIRED      // Referral expired
}

// Model for notifications
model Notification {
  id      String           @id @default(cuid())
  userId  String
  type    NotificationType
  title   String
  message String
  data    Json? // Datos adicionales (eventId, alertId, etc.)

  // Estado
  read      Boolean   @default(false)
  readAt    DateTime?
  clicked   Boolean   @default(false)
  clickedAt DateTime?

  // Delivery
  sentVia String[] // ["push", "email", "in_app"]
  sentAt  DateTime?

  // Timestamps
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
}

enum NotificationType {
  VALUE_BET_DETECTED
  ODDS_CHANGED
  PREDICTION_READY
  BET_SETTLED
  STATS_UPDATE
  SYSTEM_ALERT
}
